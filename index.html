<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>patch-cutter-browser</title>
</head>

<body>
    <input type="file" id="files" name="files" accept=".patch" />
    <output id="list"></output>
    <script src="LineReader.js"></script>
    <script src="JSZip.min.js"></script>
    <script src="FileSaver.min.js"></script>
    <script src="path-browserify.js"></script>
    <script>
        function handleFileSelect(evt) {
            var files = evt.target.files; // FileList object

            // files is a FileList of File objects. List some properties.
            var output = [];
            if (files.length) {
                output = '<li><strong>' +
                    escape(files[0].name) +
                    '</strong> (' +
                    (files[0].type || 'n/a') +
                    ') - ' +
                    files[0].size +
                    ' bytes, last modified: ' +
                    new Date(files[0].lastModified).toLocaleDateString() + '</li>';

                document.getElementById('list').innerHTML = '<ul>' + output + '</ul>';

                // Create a new instance of the LineReader
                var lr = new LineReader();
                var zip = new JSZip();

                let patchNum = 0;
                let patchPath = ''; 
                let patchContent = [];

                const patchFileName = files[0].name;

                // Bind to the line event
                lr.on('line', function (line, next) {
                    if (line.startsWith('diff --git')) {
                        if (patchNum) {
                            console.log(`Creating patch ${patchNum} (${patchPath})`);
                            zip.file(patchPath, `${patchContent.join('\n')}\n`);
                            patchContent = [];
                        }
                        patchNum++;
                        const pathMatcher = /diff --git a\/(.+) b\/(.+)/;
                        const pathMatches = line.match(pathMatcher);
                        patchPath = `${pathMatches[1]}.patch`;
                        patchContent.push(line);
                    } else {
                        if (patchNum) {
                            patchContent.push(line);
                        }
                    }

                    next(); // Call next to resume...
                });

                lr.on('end', function () {
                    if (patchNum) {
                        console.log(`Creating patch ${patchNum} (${patchPath})`);
                        zip.file(patchPath, `${patchContent.join('\n')}\n`);
                        patchContent = [];
                    }
                    zip.generateAsync({type:"blob"}).then(function(content) {
                        // see FileSaver.js
                        saveAs(content, patchFileName + '.zip');
                    });

                });

                // Begin reading the file
                lr.read(files[0]);
            }
        }

        document.getElementById('files').addEventListener('change', handleFileSelect, false);
    </script>
</body>

</html>